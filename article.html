<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMPEROR.NEWS | 記事</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body class="article-page">
  <header class="site-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <p class="brand-kicker">BLOG</p>
          <p class="brand-title">EMPEROR.NEWS</p>
        </div>
      </div>
      <div class="header-actions">
        <nav class="nav-links" aria-label="メインナビゲーション">
          <a href="index.html" class="nav-link active">トップ</a>
          <a href="admin/index.html" class="nav-link">記事投稿</a>
        </nav>
      </div>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="inner">
        <div class="article-layout">
          <article class="article-card" id="article">
            <p class="kicker">Article</p>
            <h1 id="article-title">記事が見つかりません</h1>
            <div class="meta" id="article-meta"></div>
            <div class="article-thumb placeholder" id="article-thumb" aria-hidden="true"></div>
            <div class="article-body" id="article-body">
              <p>指定された記事を読み込めませんでした。トップに戻って別の記事をお選びください。</p>
            </div>
            <div id="article-tags" class="tag-row"></div>
            <div class="article-actions">
              <a class="btn ghost" href="index.html">トップへ戻る</a>
              <a class="btn ghost" href="admin/index.html">記事投稿</a>
            </div>
          </article>
        </div>
        <div class="comments-section">
          <div class="info-card comments-card" aria-label="コメントフォーム">
            <div class="section-header">
              <div>
                <p class="kicker">コメント</p>
                <h3>感想を残す</h3>
              </div>
              <p class="muted-text" id="comment-count"></p>
            </div>

            <form id="comment-form" class="comment-form">
              <label class="field">
                <span>コメント</span>
                <textarea id="comment-body" name="comment-body" rows="4" placeholder="記事の感想や質問をどうぞ" required></textarea>
              </label>
              <button class="btn primary full" type="submit">コメントを投稿</button>
            </form>

            <div id="comment-list" class="comment-list" aria-live="polite">
              <p id="comment-empty" class="muted-text">最初のコメントを投稿しませんか？</p>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="inner footer-grid">
      <div>
        <p class="brand-title">EMPEROR.NEWS</p>
        <p class="muted-text">記事へのフィードバックをお待ちしています。</p>
      </div>
      <div class="footer-actions">
        <a class="btn ghost" href="index.html">トップへ</a>
      </div>
      <div id="site-theme-picker" class="footer-theme-picker" aria-label="表示テーマ選択"></div>
    </div>
  </footer>
  <script src="assets/data.js"></script>
  <script>
    const { readPosts, resolveTheme, readSiteTheme, saveSiteTheme, applyThemeToDocument, themes } = window.BlogData;
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');

    const titleEl = document.getElementById('article-title');
    const metaEl = document.getElementById('article-meta');
    const bodyEl = document.getElementById('article-body');
    const thumbEl = document.getElementById('article-thumb');
    const commentList = document.getElementById('comment-list');
    const commentCount = document.getElementById('comment-count');
    const emptyState = document.getElementById('comment-empty');
    const commentForm = document.getElementById('comment-form');
    const commentBodyEl = document.getElementById('comment-body');
    const siteThemePicker = document.getElementById('site-theme-picker');
    const articleCard = document.getElementById('article');
    const commentAuthor = loadCommentAuthorProfile();

    const posts = readPosts();
    let siteThemeKey = readSiteTheme();
    let siteTheme = applyThemeToDocument(siteThemeKey);
    function applySiteTheme(themeKey) {
      siteThemeKey = saveSiteTheme(themeKey);
      siteTheme = applyThemeToDocument(siteThemeKey);
      syncThemePicker();
    }

    function syncThemePicker() {
      if (!siteThemePicker) return;
      const select = siteThemePicker.querySelector('select');
      if (select) {
        select.value = siteThemeKey;
      }
    }

    function renderSiteThemePicker() {
      if (!siteThemePicker) return;
      siteThemePicker.innerHTML = `
        <label for="site-theme-select">表示テーマ</label>
        <select id="site-theme-select" aria-label="表示テーマを選択">
          ${themes.map((theme) => `<option value="${theme.key}">${theme.name}</option>`).join('')}
        </select>
      `;

      const select = siteThemePicker.querySelector('select');
      select.value = siteThemeKey;
      select.addEventListener('change', () => {
        applySiteTheme(select.value);
      });
    }

    applySiteTheme(siteThemeKey);
    const post = posts.find((item) => item.id === postId);
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox hidden';
    lightbox.innerHTML = '<img alt="拡大画像" />';
    document.body.appendChild(lightbox);

    function renderContent(text) {
      bodyEl.innerHTML = '';
      const lines = (text || '').split('\n').filter((line) => line.trim().length > 0);
      if (!lines.length) {
        const p = document.createElement('p');
        p.textContent = '本文がまだ登録されていません。';
        bodyEl.appendChild(p);
        return;
      }

      lines.forEach((line) => {
        const p = document.createElement('p');
        p.textContent = line.trim();
        bodyEl.appendChild(p);
      });
    }

    function setThumb(image, altText, position, focus, scale = 1) {
      thumbEl.innerHTML = '';
      const focusStart = focus?.start ?? 0;
      const focusEnd = focus?.end ?? 100;
      thumbEl.style.setProperty('--focus-start', `${focusStart}%`);
      thumbEl.style.setProperty('--focus-end', `${focusEnd}%`);
      thumbEl.style.setProperty('--image-scale', `${scale}`);
      if (image) {
        const img = document.createElement('img');
        img.src = image;
        img.alt = `${altText}の画像`;
        img.style.objectPosition = `center ${(position ?? 50)}%`;
        thumbEl.classList.remove('placeholder');
        thumbEl.removeAttribute('aria-hidden');
        const focusGuide = document.createElement('div');
        focusGuide.className = 'focus-range';
        focusGuide.setAttribute('aria-hidden', 'true');
        thumbEl.appendChild(focusGuide);
        thumbEl.appendChild(img);
        img.addEventListener('click', () => openLightbox(image, altText));
        return;
      }

      const focusGuide = document.createElement('div');
      focusGuide.className = 'focus-range';
      focusGuide.setAttribute('aria-hidden', 'true');
      thumbEl.appendChild(focusGuide);
      thumbEl.appendChild(document.createTextNode('画像未設定'));
      thumbEl.classList.add('placeholder');
      thumbEl.setAttribute('aria-hidden', 'true');
    }

    function renderArticle() {
      if (!post) {
        titleEl.textContent = '記事が見つかりません';
        metaEl.textContent = '';
        renderContent('記事が見つかりませんでした。トップへ戻って別の記事をお試しください。');
        setThumb('', '');
        if (commentForm) commentForm.hidden = true;
        commentCount.textContent = '';
        return;
      }

      const theme = resolveTheme(post.theme || siteTheme.key);
      if (articleCard) {
        articleCard.style.setProperty('--accent', theme.accent);
        articleCard.style.setProperty('--accent-2', theme.accent2);
      }

      if (commentForm) commentForm.hidden = false;
      titleEl.textContent = post.title;
      metaEl.textContent = `${post.date} • ${post.read}`;
      renderContent(post.content || post.excerpt);
      setThumb(post.image, post.title, post.imagePosition, post.imageFocus, post.imageScale);
      renderTags(post.tags || []);
    }

    function renderTags(tags = []) {
      const container = document.getElementById('article-tags');
      container.innerHTML = '';
      if (!tags.length) return;
      tags.forEach((tag) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = `#${tag}`;
        container.appendChild(span);
      });
    }

    function openLightbox(src, alt) {
      const img = lightbox.querySelector('img');
      img.src = src;
      img.alt = alt || '拡大画像';
      lightbox.classList.remove('hidden');
    }

    lightbox.addEventListener('click', () => {
      lightbox.classList.add('hidden');
    });

    function commentStorageKey(id) {
      return `comments:${id}`;
    }

    function commentAuthorKey() {
      return 'comment-author-profile';
    }

    function generateAuthorId() {
      if (window.crypto && typeof window.crypto.randomUUID === 'function') {
        return window.crypto.randomUUID();
      }
      return `author-${Date.now().toString(36)}-${Math.random().toString(16).slice(2)}`;
    }

    function loadCommentAuthorProfile() {
      try {
        const saved = JSON.parse(localStorage.getItem(commentAuthorKey()) || '{}');
        if (saved && saved.id) {
          return saved;
        }
      } catch (error) {
        console.warn('投稿者情報の読み込みに失敗しました。', error);
      }
      const profile = {
        id: generateAuthorId(),
        label: 'あなた',
      };
      localStorage.setItem(commentAuthorKey(), JSON.stringify(profile));
      return profile;
    }

    function loadComments(id) {
      try {
        const saved = JSON.parse(localStorage.getItem(commentStorageKey(id)) || '[]');
        if (Array.isArray(saved)) {
          return saved;
        }
        return [];
      } catch (error) {
        console.warn('コメントの読み込みに失敗しました。', error);
        return [];
      }
    }

    function saveComments(id, comments) {
      localStorage.setItem(commentStorageKey(id), JSON.stringify(comments));
    }

    function renderComments(comments) {
      commentList.innerHTML = '';
      if (!comments.length) {
        emptyState.hidden = false;
        commentCount.textContent = '0件のコメント';
        commentList.appendChild(emptyState);
        return;
      }

      emptyState.hidden = true;
      commentCount.textContent = `${comments.length}件のコメント`;

      comments.forEach((comment) => {
        const article = document.createElement('article');
        article.className = 'comment-card';
        const isOwner = comment.authorId && comment.authorId === commentAuthor.id;

        const header = document.createElement('div');
        header.className = 'comment-header';
        const name = document.createElement('strong');
        name.textContent = isOwner ? commentAuthor.label : comment.name || '匿名';
        const time = document.createElement('span');
        const date = new Date(comment.createdAt || Date.now());
        time.textContent = date.toLocaleString('ja-JP');
        header.appendChild(name);
        header.appendChild(time);

        const body = document.createElement('p');
        body.textContent = comment.body;

        article.appendChild(header);
        article.appendChild(body);

        if (isOwner) {
          const actions = document.createElement('div');
          actions.className = 'comment-actions';
          const editButton = document.createElement('button');
          editButton.type = 'button';
          editButton.className = 'btn ghost';
          editButton.textContent = '編集';
          editButton.addEventListener('click', () => handleEditComment(comment));
          const deleteButton = document.createElement('button');
          deleteButton.type = 'button';
          deleteButton.className = 'btn ghost';
          deleteButton.textContent = '削除';
          deleteButton.addEventListener('click', () => handleDeleteComment(comment));
          actions.appendChild(editButton);
          actions.appendChild(deleteButton);
          article.appendChild(actions);
        }
        commentList.appendChild(article);
      });
    }

    function handleEditComment(comment) {
      const nextBody = window.prompt('コメントを編集', comment.body || '');
      if (nextBody === null) return;
      const trimmed = nextBody.trim();
      if (!trimmed) {
        alert('コメントを入力してください。');
        return;
      }
      const current = loadComments(post.id);
      const updated = current.map((item) =>
        item.id === comment.id
          ? {
              ...item,
              body: trimmed,
              updatedAt: new Date().toISOString(),
            }
          : item
      );
      saveComments(post.id, updated);
      renderComments(updated);
    }

    function handleDeleteComment(comment) {
      if (!window.confirm('このコメントを削除しますか？')) return;
      const current = loadComments(post.id);
      const updated = current.filter((item) => item.id !== comment.id);
      saveComments(post.id, updated);
      renderComments(updated);
    }

    function handleCommentSubmit(event) {
      event.preventDefault();
      if (!post) return;

      const body = commentBodyEl.value.trim();
      if (!body) {
        alert('コメントを入力してください。');
        return;
      }

      const current = loadComments(post.id);
      const newComment = {
        id: `comment-${Date.now()}`,
        name: '匿名',
        body,
        createdAt: new Date().toISOString(),
        authorId: commentAuthor.id,
      };
      const updated = [newComment, ...current].slice(0, 100);
      saveComments(post.id, updated);
      renderComments(updated);
      commentForm.reset();
    }

    renderArticle();
    renderSiteThemePicker();
    syncThemePicker();

    if (post) {
      const initialComments = loadComments(post.id);
      renderComments(initialComments);
      commentForm.addEventListener('submit', handleCommentSubmit);
    } else {
      commentList.innerHTML = '';
      emptyState.hidden = false;
      commentList.appendChild(emptyState);
    }
  </script>
</body>
</html>
