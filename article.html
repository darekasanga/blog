<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMPEROR.NEWS | è¨˜äº‹</title>
  <link rel="stylesheet" href="assets/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <p class="brand-kicker">BLOG</p>
          <p class="brand-title">EMPEROR.NEWS</p>
        </div>
      </div>
      <nav class="nav-links nav-icons" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <a href="admin/index.html#csv-import" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">CSV</span>
          <span class="nav-icon-label">CSVå–è¾¼ã¿</span>
        </a>
        <a href="admin/index.html#settings" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">âš™</span>
          <span class="nav-icon-label">è¨­å®š</span>
        </a>
        <a href="index.html" class="nav-link nav-icon active">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ </span>
          <span class="nav-icon-label">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</span>
        </a>
        <a href="admin/index.html#login" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ”‘</span>
          <span class="nav-icon-label">ãƒ­ã‚°ã‚¤ãƒ³</span>
        </a>
        <a href="admin/index.html#user" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ‘¤</span>
          <span class="nav-icon-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="inner article-layout">
        <article class="article-card" id="article">
          <p class="kicker">Article</p>
          <h1 id="article-title">è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</h1>
          <div class="meta" id="article-meta"></div>
          <div class="article-thumb placeholder" id="article-thumb" aria-hidden="true"></div>
          <div class="article-body" id="article-body">
            <p>æŒ‡å®šã•ã‚ŒãŸè¨˜äº‹ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒˆãƒƒãƒ—ã«æˆ»ã£ã¦åˆ¥ã®è¨˜äº‹ã‚’ãŠé¸ã³ãã ã•ã„ã€‚</p>
          </div>
          <div id="article-tags" class="tag-row"></div>
          <div class="article-actions">
            <a class="btn ghost" href="index.html">ãƒˆãƒƒãƒ—ã¸æˆ»ã‚‹</a>
            <a class="btn ghost" href="admin/index.html">ç®¡ç†ãƒšãƒ¼ã‚¸</a>
          </div>
        </article>

        <aside class="info-card comments-card">
          <div class="section-header">
            <div>
              <p class="kicker">ã‚³ãƒ¡ãƒ³ãƒˆ</p>
              <h3>æ„Ÿæƒ³ã‚’æ®‹ã™</h3>
            </div>
            <p class="muted-text" id="comment-count"></p>
          </div>

          <form id="comment-form" class="comment-form">
            <label class="field">
              <span>ãŠåå‰</span>
              <input id="commenter" name="commenter" type="text" placeholder="ãƒšãƒ³ãƒãƒ¼ãƒ ã§OK" required />
            </label>
            <label class="field">
              <span>ã‚³ãƒ¡ãƒ³ãƒˆ</span>
              <textarea id="comment-body" name="comment-body" rows="4" placeholder="è¨˜äº‹ã®æ„Ÿæƒ³ã‚„è³ªå•ã‚’ã©ã†ã" required></textarea>
            </label>
            <button class="btn primary full" type="submit">ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿</button>
          </form>

          <div id="comment-list" class="comment-list" aria-live="polite">
            <p id="comment-empty" class="muted-text">æœ€åˆã®ã‚³ãƒ¡ãƒ³ãƒˆã‚’æŠ•ç¨¿ã—ã¾ã›ã‚“ã‹ï¼Ÿ</p>
          </div>
        </aside>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="inner footer-grid">
      <div>
        <p class="brand-title">EMPEROR.NEWS</p>
        <p class="muted-text">è¨˜äº‹ã¸ã®ãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ã‚’ãŠå¾…ã¡ã—ã¦ã„ã¾ã™ã€‚</p>
      </div>
      <div class="footer-actions">
        <a class="btn ghost" href="index.html">ãƒˆãƒƒãƒ—ã¸</a>
        <a class="btn ghost" href="admin/index.html">ç®¡ç†ãƒšãƒ¼ã‚¸</a>
      </div>
    </div>
  </footer>

  <script src="assets/data.js"></script>
  <script>
    const { readPosts } = window.BlogData;
    const params = new URLSearchParams(window.location.search);
    const postId = params.get('id');

    const titleEl = document.getElementById('article-title');
    const metaEl = document.getElementById('article-meta');
    const bodyEl = document.getElementById('article-body');
    const thumbEl = document.getElementById('article-thumb');
    const commentList = document.getElementById('comment-list');
    const commentCount = document.getElementById('comment-count');
    const emptyState = document.getElementById('comment-empty');
    const commentForm = document.getElementById('comment-form');
    const commenterEl = document.getElementById('commenter');
    const commentBodyEl = document.getElementById('comment-body');

    const posts = readPosts();
    const post = posts.find((item) => item.id === postId);
    const lightbox = document.createElement('div');
    lightbox.className = 'lightbox hidden';
    lightbox.innerHTML = '<img alt="æ‹¡å¤§ç”»åƒ" />';
    document.body.appendChild(lightbox);

    function renderContent(text) {
      bodyEl.innerHTML = '';
      const lines = (text || '').split('\n').filter((line) => line.trim().length > 0);
      if (!lines.length) {
        const p = document.createElement('p');
        p.textContent = 'æœ¬æ–‡ãŒã¾ã ç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚';
        bodyEl.appendChild(p);
        return;
      }

      lines.forEach((line) => {
        const p = document.createElement('p');
        p.textContent = line.trim();
        bodyEl.appendChild(p);
      });
    }

    function setThumb(image, altText, position) {
      thumbEl.innerHTML = '';
      if (image) {
        const img = document.createElement('img');
        img.src = image;
        img.alt = `${altText}ã®ç”»åƒ`;
        img.style.objectPosition = `center ${(position ?? 50)}%`;
        thumbEl.classList.remove('placeholder');
        thumbEl.removeAttribute('aria-hidden');
        thumbEl.appendChild(img);
        img.addEventListener('click', () => openLightbox(image, altText));
        return;
      }

      thumbEl.textContent = 'ç”»åƒæœªè¨­å®š';
      thumbEl.classList.add('placeholder');
      thumbEl.setAttribute('aria-hidden', 'true');
    }

    function renderArticle() {
      if (!post) {
        titleEl.textContent = 'è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“';
        metaEl.textContent = '';
        renderContent('è¨˜äº‹ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸã€‚ãƒˆãƒƒãƒ—ã¸æˆ»ã£ã¦åˆ¥ã®è¨˜äº‹ã‚’ãŠè©¦ã—ãã ã•ã„ã€‚');
        setThumb('', '');
        commentForm.hidden = true;
        commentCount.textContent = '';
        return;
      }

      commentForm.hidden = false;
      titleEl.textContent = post.title;
      metaEl.textContent = `${post.date} â€¢ ${post.read}`;
      renderContent(post.content || post.excerpt);
      setThumb(post.image, post.title, post.imagePosition);
      renderTags(post.tags || []);
    }

    function renderTags(tags = []) {
      const container = document.getElementById('article-tags');
      container.innerHTML = '';
      if (!tags.length) return;
      tags.forEach((tag) => {
        const span = document.createElement('span');
        span.className = 'chip';
        span.textContent = `#${tag}`;
        container.appendChild(span);
      });
    }

    function openLightbox(src, alt) {
      const img = lightbox.querySelector('img');
      img.src = src;
      img.alt = alt || 'æ‹¡å¤§ç”»åƒ';
      lightbox.classList.remove('hidden');
    }

    lightbox.addEventListener('click', () => {
      lightbox.classList.add('hidden');
    });

    function commentStorageKey(id) {
      return `comments:${id}`;
    }

    function loadComments(id) {
      try {
        const saved = JSON.parse(localStorage.getItem(commentStorageKey(id)) || '[]');
        if (Array.isArray(saved)) {
          return saved;
        }
        return [];
      } catch (error) {
        console.warn('ã‚³ãƒ¡ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚', error);
        return [];
      }
    }

    function saveComments(id, comments) {
      localStorage.setItem(commentStorageKey(id), JSON.stringify(comments));
    }

    function renderComments(comments) {
      commentList.innerHTML = '';
      if (!comments.length) {
        emptyState.hidden = false;
        commentCount.textContent = '0ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆ';
        commentList.appendChild(emptyState);
        return;
      }

      emptyState.hidden = true;
      commentCount.textContent = `${comments.length}ä»¶ã®ã‚³ãƒ¡ãƒ³ãƒˆ`;

      comments.forEach((comment) => {
        const article = document.createElement('article');
        article.className = 'comment-card';

        const header = document.createElement('div');
        header.className = 'comment-header';
        const name = document.createElement('strong');
        name.textContent = comment.name;
        const time = document.createElement('span');
        const date = new Date(comment.createdAt || Date.now());
        time.textContent = date.toLocaleString('ja-JP');
        header.appendChild(name);
        header.appendChild(time);

        const body = document.createElement('p');
        body.textContent = comment.body;

        article.appendChild(header);
        article.appendChild(body);
        commentList.appendChild(article);
      });
    }

    function handleCommentSubmit(event) {
      event.preventDefault();
      if (!post) return;

      const name = commenterEl.value.trim() || 'åç„¡ã—ã•ã‚“';
      const body = commentBodyEl.value.trim();
      if (!body) {
        alert('ã‚³ãƒ¡ãƒ³ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
        return;
      }

      const current = loadComments(post.id);
      const newComment = {
        id: `comment-${Date.now()}`,
        name,
        body,
        createdAt: new Date().toISOString(),
      };
      const updated = [newComment, ...current].slice(0, 100);
      saveComments(post.id, updated);
      renderComments(updated);
      commentForm.reset();
    }

    renderArticle();

    if (post) {
      const initialComments = loadComments(post.id);
      renderComments(initialComments);
      commentForm.addEventListener('submit', handleCommentSubmit);
    } else {
      commentList.innerHTML = '';
      emptyState.hidden = false;
      commentList.appendChild(emptyState);
    }
  </script>
</body>
</html>
