<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMPEROR.NEWS | ç®¡ç†ãƒšãƒ¼ã‚¸</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <p class="brand-kicker">BLOG</p>
          <p class="brand-title">EMPEROR.NEWS</p>
        </div>
      </div>
      <nav class="nav-links nav-icons" aria-label="ãƒ¡ã‚¤ãƒ³ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³">
        <a href="#csv-import" class="nav-link nav-icon active">
          <span class="nav-icon-mark" aria-hidden="true">CSV</span>
          <span class="nav-icon-label">CSVå–è¾¼ã¿</span>
        </a>
        <a href="#settings" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">âš™</span>
          <span class="nav-icon-label">è¨­å®š</span>
        </a>
        <a href="../index.html" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ </span>
          <span class="nav-icon-label">ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸</span>
        </a>
        <a href="#login" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ”‘</span>
          <span class="nav-icon-label">ãƒ­ã‚°ã‚¤ãƒ³</span>
        </a>
        <a href="#user" class="nav-link nav-icon">
          <span class="nav-icon-mark" aria-hidden="true">ğŸ‘¤</span>
          <span class="nav-icon-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>
        </a>
      </nav>
    </div>
  </header>

  <main>
    <div class="nav-anchor" id="csv-import" aria-hidden="true"></div>
    <section class="section">
      <div class="inner">
        <p class="kicker">æŠ•ç¨¿ç®¡ç†</p>
        <h1>æ–°è¦æŠ•ç¨¿ã¨ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</h1>
        <p class="lead">æŠ•ç¨¿æ©Ÿèƒ½ã‚’ã“ã®ç®¡ç†ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã—ãŸã€‚å…¥åŠ›å†…å®¹ã¯ä¸‹ã®ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚«ãƒ¼ãƒ‰ã«åæ˜ ã•ã‚Œã¾ã™ã€‚</p>

        <div class="info-grid" style="align-items: stretch;">
          <form class="info-card" id="post-form">
            <div class="field">
              <label for="title">ã‚¿ã‚¤ãƒˆãƒ«</label>
              <input id="title" name="title" type="text" placeholder="ä¾‹ï¼‰çµ±ä¸€æ„Ÿã®ã‚ã‚‹UIã®ä½œã‚Šæ–¹" required />
            </div>
            <div class="field-grid">
              <div class="field">
                <label for="date">æ—¥ä»˜</label>
                <input id="date" name="date" type="date" required />
              </div>
              <div class="field">
                <label for="read">èª­äº†æ™‚é–“</label>
                <input id="read" name="read" type="text" placeholder="5 min" required />
              </div>
            </div>
            <div class="field">
              <label for="excerpt">æ¦‚è¦</label>
              <textarea id="excerpt" name="excerpt" rows="4" placeholder="æ¦‚è¦ã‚’å…¥åŠ›" required></textarea>
            </div>
            <div class="field-grid">
              <div class="field">
                <label for="tags">ã‚¿ã‚°ï¼ˆæœ€å¤§2ã¤ãƒ»ã‚«ãƒ³ãƒåŒºåˆ‡ã‚Šï¼‰</label>
                <input id="tags" name="tags" type="text" placeholder="ä¾‹ï¼‰ãƒ‡ã‚¶ã‚¤ãƒ³, UI" />
                <p class="muted-text" style="margin: 6px 0 0;">ãƒˆãƒƒãƒ—ã¨è¨˜äº‹ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>
              </div>
              <div class="field">
                <label for="image-position">ç”»åƒã®è¡¨ç¤ºä½ç½®ï¼ˆ0-100ï¼‰</label>
                <input id="image-position" name="image-position" type="range" min="0" max="100" value="50" />
                <p class="muted-text" style="margin: 6px 0 0;">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼ç”»åƒã®ç¸¦ä½ç½®ã‚’èª¿æ•´ã—ã¾ã™ã€‚</p>
              </div>
            </div>
            <div class="field">
              <label for="content">æœ¬æ–‡</label>
              <textarea id="content" name="content" rows="6" placeholder="æœ¬æ–‡ã‚’å…¥åŠ›ã€‚æ”¹è¡Œã‚‚åæ˜ ã•ã‚Œã¾ã™ã€‚" required></textarea>
            </div>
            <div class="field">
              <label for="image">è¨˜äº‹ç”»åƒ</label>
              <input id="image" name="image" type="file" accept="image/*" />
              <p class="muted-text" style="margin: 6px 0 0;">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾Œã€è‡ªå‹•ã§ãƒªã‚µã‚¤ã‚ºã—ã¦ä¿å­˜ã—ã¾ã™ã€‚</p>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit" id="submit-button">è¨˜äº‹ã‚’ç™»éŒ²</button>
              <button class="btn ghost" type="button" id="cancel-edit" aria-live="polite" hidden>ç·¨é›†ã‚’ã‚„ã‚ã‚‹</button>
              <a class="btn ghost" href="../index.html">ãƒˆãƒƒãƒ—ã§ç¢ºèª</a>
            </div>
          </form>

          <div class="info-card">
            <p class="kicker">ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼</p>
            <article class="card" id="preview-card">
              <div class="card-thumb placeholder" id="preview-thumb" aria-hidden="true"></div>
              <div class="meta">
                <span id="preview-date">2024-05-28</span>
                <span>â€¢</span>
                <span id="preview-read">5 min</span>
              </div>
              <h3 id="preview-title">ãƒ‡ã‚¶ã‚¤ãƒ³ã‚·ã‚¹ãƒ†ãƒ ã§çµ±ä¸€æ„Ÿã‚’ä½œã‚‹</h3>
              <p id="preview-excerpt">è‰²ãƒ»ä½™ç™½ãƒ»ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã‚’æƒãˆã€ãƒ—ãƒ­ãƒ€ã‚¯ãƒˆå…¨ä½“ã®ä½“é¨“ã‚’å‘ä¸Šã•ã›ã‚‹æ–¹æ³•ã‚’ã¾ã¨ã‚ã¾ã—ãŸã€‚</p>
              <div class="actions">
                <button class="btn primary full" type="button">è¨˜äº‹ã‚’èª­ã‚€</button>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>

    <div class="nav-anchor" id="settings" aria-hidden="true"></div>
    <section class="section muted">
      <div class="inner">
        <div class="section-header">
          <div>
            <p class="kicker">æŠ•ç¨¿ä¸€è¦§</p>
            <h2>ä¿å­˜æ¸ˆã¿ã®è¨˜äº‹</h2>
          </div>
          <p class="muted-text" id="post-count"></p>
        </div>
        <div id="post-list" class="management-list" aria-live="polite"></div>
      </div>
    </section>

    <div class="nav-anchor" id="login" aria-hidden="true"></div>
    <div class="nav-anchor" id="user" aria-hidden="true"></div>
  </main>

  <footer class="site-footer">
    <div class="inner footer-grid">
      <div>
        <p class="brand-title">EMPEROR.NEWS</p>
        <p class="muted-text">æŠ•ç¨¿ã¯ç®¡ç†ãƒšãƒ¼ã‚¸ã‹ã‚‰è¡Œãˆã¾ã™ã€‚</p>
      </div>
      <div class="footer-actions">
        <a class="btn ghost" href="../index.html">ãƒˆãƒƒãƒ—ã¸</a>
      </div>
    </div>
  </footer>

  <script src="../assets/data.js"></script>
  <script>
    const { readPosts, savePosts, normalizePost, escapeHtml } = window.BlogData;

    const form = document.getElementById('post-form');
    const titleEl = document.getElementById('title');
    const dateEl = document.getElementById('date');
    const readEl = document.getElementById('read');
    const excerptEl = document.getElementById('excerpt');
    const contentEl = document.getElementById('content');
    const imageEl = document.getElementById('image');
    const tagsEl = document.getElementById('tags');
    const imagePositionEl = document.getElementById('image-position');
    const postList = document.getElementById('post-list');
    const postCount = document.getElementById('post-count');
    const cancelEditButton = document.getElementById('cancel-edit');
    const submitButton = document.getElementById('submit-button');

    const previewTitle = document.getElementById('preview-title');
    const previewDate = document.getElementById('preview-date');
    const previewRead = document.getElementById('preview-read');
    const previewExcerpt = document.getElementById('preview-excerpt');
    const previewThumb = document.getElementById('preview-thumb');
    const previewTags = document.createElement('div');
    previewTags.className = 'tag-row';
    previewThumb.insertAdjacentElement('afterend', previewTags);

    const today = new Date().toISOString().slice(0, 10);
    dateEl.value = today;
    previewDate.textContent = today;

    let resizedImageData = '';
    let posts = readPosts();
    let editingId = null;

    function removeLongVacationButtons() {
      document.querySelectorAll('button').forEach((button) => {
        if (button.textContent.trim() === 'é•·æœŸä¼‘æš‡') {
          button.remove();
        }
      });
    }

    removeLongVacationButtons();

    function updatePreview() {
      previewTitle.textContent = titleEl.value || 'ç„¡é¡Œã®æŠ•ç¨¿';
      previewDate.textContent = dateEl.value || today;
      previewRead.textContent = readEl.value || '5 min';
      previewExcerpt.textContent = excerptEl.value || 'æ¦‚è¦ã‚’å…¥åŠ›ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚';
      const tags = window.BlogData.normalizeTags(tagsEl.value.split(','));
      previewTags.innerHTML = tags.map((tag) => `<span class=\"chip\">#${window.BlogData.escapeHtml(tag)}</span>`).join('');

      if (resizedImageData) {
        previewThumb.innerHTML = `<img src=\"${resizedImageData}\" alt=\"${escapeHtml(previewTitle.textContent)}ã®ç”»åƒ\" style=\"object-position:center ${imagePositionEl.value}%\" />`;
        previewThumb.classList.remove('placeholder');
        previewThumb.removeAttribute('aria-hidden');
      } else {
        previewThumb.innerHTML = '';
        previewThumb.classList.add('placeholder');
        previewThumb.setAttribute('aria-hidden', 'true');
      }
    }

    function downscaleImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxWidth = 1200;
            const maxHeight = 1200;
            const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);
            const width = Math.round(img.width * scale);
            const height = Math.round(img.height * scale);
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.9));
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    function renderPostList() {
      if (!posts.length) {
        postCount.textContent = 'ã¾ã æŠ•ç¨¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚';
        postList.innerHTML = '<p class=\"muted-text\">æŠ•ç¨¿ã‚’è¿½åŠ ã™ã‚‹ã¨ã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚</p>';
        return;
      }

      postCount.textContent = `${posts.length}ä»¶ã®æŠ•ç¨¿`;
      postList.innerHTML = posts
        .map(
          (post) => `
            <article class=\"manage-card\" data-id=\"${post.id}\">
              <div class=\"manage-summary\">
                <p class=\"meta\"><span>${escapeHtml(post.date)}</span><span>â€¢</span><span>${escapeHtml(post.read)}</span></p>
                <h3>${escapeHtml(post.title)}</h3>
                <p class=\"muted-text\">${escapeHtml(post.excerpt)}</p>
                <div class=\"tag-row\">${(post.tags || []).map((tag) => `<span class=\"chip\">#${escapeHtml(tag)}</span>`).join('')}</div>
              </div>
              <div class=\"manage-actions\">
                <a class=\"btn ghost\" href=\"../article.html?id=${encodeURIComponent(post.id)}\">è¨˜äº‹ã‚’è¡¨ç¤º</a>
                <button class=\"btn primary\" type=\"button\" data-action=\"edit\">ç·¨é›†</button>
                <button class=\"btn danger\" type=\"button\" data-action=\"delete\">å‰Šé™¤</button>
              </div>
            </article>
          `
        )
        .join('');

      postList.querySelectorAll('button[data-action=\"edit\"]').forEach((button) => {
        button.addEventListener('click', () => {
          const postId = button.closest('[data-id]')?.dataset.id;
          if (postId) {
            startEdit(postId);
          }
        });
      });

      postList.querySelectorAll('button[data-action=\"delete\"]').forEach((button) => {
        button.addEventListener('click', () => {
          const postId = button.closest('[data-id]')?.dataset.id;
          if (postId) {
            deletePost(postId);
          }
        });
      });

      attachSwipeHandlers();
    }

    function attachSwipeHandlers() {
      const threshold = 40;
      postList.querySelectorAll('.manage-card').forEach((card) => {
        let startX = null;
        card.addEventListener('pointerdown', (event) => {
          startX = event.clientX;
          card.setPointerCapture(event.pointerId);
        });

        card.addEventListener('pointermove', (event) => {
          if (startX === null) return;
          const deltaX = event.clientX - startX;
          if (deltaX < -threshold) {
            card.classList.add('show-actions');
          } else if (deltaX > threshold) {
            card.classList.remove('show-actions');
          }
        });

        const clearSwipe = () => {
          startX = null;
        };

        card.addEventListener('pointerup', clearSwipe);
        card.addEventListener('pointercancel', clearSwipe);
      });
    }

    function resetForm() {
      form.reset();
      resizedImageData = '';
      editingId = null;
      submitButton.textContent = 'è¨˜äº‹ã‚’ç™»éŒ²';
      cancelEditButton.hidden = true;
      dateEl.value = today;
      tagsEl.value = '';
      imagePositionEl.value = '50';
      updatePreview();
    }

    function startEdit(id) {
      const target = posts.find((post) => post.id === id);
      if (!target) {
        return;
      }

      editingId = id;
      titleEl.value = target.title;
      dateEl.value = target.date;
      readEl.value = target.read;
      excerptEl.value = target.excerpt;
      contentEl.value = target.content || '';
      resizedImageData = target.image || '';
      tagsEl.value = (target.tags || []).join(', ');
      imagePositionEl.value = target.imagePosition ?? 50;
      submitButton.textContent = 'å¤‰æ›´ã‚’ä¿å­˜';
      cancelEditButton.hidden = false;
      updatePreview();
      form.scrollIntoView({ behavior: 'smooth', block: 'center' });
    }

    function deletePost(id) {
      const target = posts.find((post) => post.id === id);
      if (!target) return;
      const confirmed = window.confirm(`ã€Œ${target.title}ã€ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`);
      if (!confirmed) return;
      posts = posts.filter((post) => post.id !== id);
      savePosts(posts);
      if (editingId === id) {
        resetForm();
      }
      renderPostList();
    }

    [titleEl, dateEl, readEl, excerptEl, contentEl, tagsEl, imagePositionEl].forEach((el) => {
      el.addEventListener('input', updatePreview);
    });

    imageEl.addEventListener('change', async (event) => {
      const file = event.target.files?.[0];
      if (!file) {
        resizedImageData = editingId ? posts.find((p) => p.id === editingId)?.image || '' : '';
        updatePreview();
        return;
      }

      if (!file.type.startsWith('image/')) {
        alert('ç”»åƒãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        imageEl.value = '';
        return;
      }

      try {
        resizedImageData = await downscaleImage(file);
        updatePreview();
      } catch (error) {
        console.error(error);
        alert('ç”»åƒã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚åˆ¥ã®ãƒ•ã‚¡ã‚¤ãƒ«ã§ãŠè©¦ã—ãã ã•ã„ã€‚');
        resizedImageData = editingId ? posts.find((p) => p.id === editingId)?.image || '' : '';
        updatePreview();
      }
    });

    cancelEditButton.addEventListener('click', resetForm);

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      updatePreview();

      const title = previewTitle.textContent.trim();
      const date = previewDate.textContent.trim();
      const read = previewRead.textContent.trim();
      const excerpt = previewExcerpt.textContent.trim();
      const content = contentEl.value.trim();
      const existing = editingId ? posts.find((post) => post.id === editingId) : null;
      const image = resizedImageData || existing?.image || '';
      const tags = window.BlogData.normalizeTags(tagsEl.value.split(','));
      const imagePosition = Number(imagePositionEl.value || 50);

      const preparedPost = normalizePost(
        {
          ...(existing || {}),
          id: editingId || `post-${Date.now()}`,
          title,
          date,
          read,
          excerpt,
          content,
          image,
          tags,
          imagePosition,
        },
        posts.length
      );

      if (editingId) {
        posts = posts.map((post) => (post.id === editingId ? preparedPost : post));
      } else {
        posts = [preparedPost, ...posts];
      }

      savePosts(posts);
      renderPostList();
      alert(editingId ? 'å¤‰æ›´ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚' : 'æŠ•ç¨¿ã‚’ä¿å­˜ã—ã¾ã—ãŸã€‚ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã§ç¢ºèªã§ãã¾ã™ã€‚');
      resetForm();
    });

    renderPostList();
    updatePreview();
  </script>
</body>
</html>
