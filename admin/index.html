<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMPEROR.NEWS | 管理ページ</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body>
  <header class="site-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <p class="brand-kicker">BLOG</p>
          <p class="brand-title">EMPEROR.NEWS</p>
        </div>
      </div>
      <nav class="nav-links" aria-label="メインナビゲーション">
        <a href="../index.html" class="nav-link">トップ</a>
        <a href="index.html" class="nav-link active">管理</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="inner">
        <p class="kicker">投稿管理</p>
        <h1>新規投稿とプレビュー</h1>
        <p class="lead">投稿機能をこの管理ページへ移動しました。入力内容は下のプレビューカードに反映されます。</p>

        <div class="info-grid" style="align-items: stretch;">
          <form class="info-card" id="post-form">
            <div class="field">
              <label for="title">タイトル</label>
              <input id="title" name="title" type="text" placeholder="例）統一感のあるUIの作り方" required />
            </div>
            <div class="field-grid">
              <div class="field">
                <label for="date">日付</label>
                <input id="date" name="date" type="date" required />
              </div>
              <div class="field">
                <label for="read">読了時間</label>
                <input id="read" name="read" type="text" placeholder="5 min" required />
              </div>
            </div>
            <div class="field">
              <label for="excerpt">概要</label>
              <textarea id="excerpt" name="excerpt" rows="4" placeholder="概要を入力" required></textarea>
            </div>
            <div class="field">
              <label for="image">記事画像</label>
              <input id="image" name="image" type="file" accept="image/*" />
              <p class="muted-text" style="margin: 6px 0 0;">アップロード後、自動でリサイズして保存します。</p>
            </div>
            <div class="form-actions">
              <button class="btn primary" type="submit">記事を登録</button>
              <a class="btn ghost" href="../index.html">トップで確認</a>
            </div>
          </form>

          <div class="info-card">
            <p class="kicker">プレビュー</p>
            <article class="card" id="preview-card">
              <div class="card-thumb placeholder" id="preview-thumb" aria-hidden="true"></div>
              <div class="meta">
                <span id="preview-date">2024-05-28</span>
                <span>•</span>
                <span id="preview-read">5 min</span>
              </div>
              <h3 id="preview-title">デザインシステムで統一感を作る</h3>
              <p id="preview-excerpt">色・余白・コンポーネントを揃え、プロダクト全体の体験を向上させる方法をまとめました。</p>
              <div class="actions">
                <button class="btn primary full" type="button">記事を読む</button>
              </div>
            </article>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="inner footer-grid">
      <div>
        <p class="brand-title">EMPEROR.NEWS</p>
        <p class="muted-text">投稿は管理ページから行えます。</p>
      </div>
      <div class="footer-actions">
        <a class="btn ghost" href="../index.html">トップへ</a>
      </div>
    </div>
  </footer>

  <script>
    const form = document.getElementById('post-form');
    const titleEl = document.getElementById('title');
    const dateEl = document.getElementById('date');
    const readEl = document.getElementById('read');
    const excerptEl = document.getElementById('excerpt');
    const imageEl = document.getElementById('image');

    const previewTitle = document.getElementById('preview-title');
    const previewDate = document.getElementById('preview-date');
    const previewRead = document.getElementById('preview-read');
    const previewExcerpt = document.getElementById('preview-excerpt');
    const previewThumb = document.getElementById('preview-thumb');

    const today = new Date().toISOString().slice(0, 10);
    dateEl.value = today;
    previewDate.textContent = today;

    let resizedImageData = '';

    function updatePreview() {
      previewTitle.textContent = titleEl.value || '無題の投稿';
      previewDate.textContent = dateEl.value || today;
      previewRead.textContent = readEl.value || '5 min';
      previewExcerpt.textContent = excerptEl.value || '概要を入力するとここに表示されます。';

      if (resizedImageData) {
        previewThumb.innerHTML = `<img src="${resizedImageData}" alt="${previewTitle.textContent}の画像" />`;
        previewThumb.classList.remove('placeholder');
        previewThumb.removeAttribute('aria-hidden');
      } else {
        previewThumb.innerHTML = '';
        previewThumb.classList.add('placeholder');
        previewThumb.setAttribute('aria-hidden', 'true');
      }
    }

    function downscaleImage(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = () => {
          const img = new Image();
          img.onload = () => {
            const canvas = document.createElement('canvas');
            const maxWidth = 1200;
            const maxHeight = 1200;
            const scale = Math.min(maxWidth / img.width, maxHeight / img.height, 1);
            const width = Math.round(img.width * scale);
            const height = Math.round(img.height * scale);
            canvas.width = width;
            canvas.height = height;
            const ctx = canvas.getContext('2d');
            ctx.drawImage(img, 0, 0, width, height);
            resolve(canvas.toDataURL('image/jpeg', 0.9));
          };
          img.onerror = reject;
          img.src = reader.result;
        };
        reader.onerror = reject;
        reader.readAsDataURL(file);
      });
    }

    [titleEl, dateEl, readEl, excerptEl].forEach((el) => {
      el.addEventListener('input', updatePreview);
    });

    imageEl.addEventListener('change', async (event) => {
      const file = event.target.files?.[0];
      if (!file) {
        resizedImageData = '';
        updatePreview();
        return;
      }

      if (!file.type.startsWith('image/')) {
        alert('画像ファイルを選択してください。');
        imageEl.value = '';
        return;
      }

      try {
        resizedImageData = await downscaleImage(file);
        updatePreview();
      } catch (error) {
        console.error(error);
        alert('画像の読み込みに失敗しました。別のファイルでお試しください。');
        resizedImageData = '';
        updatePreview();
      }
    });

    form.addEventListener('submit', (e) => {
      e.preventDefault();
      updatePreview();

      const newPost = {
        title: previewTitle.textContent,
        date: previewDate.textContent,
        read: previewRead.textContent,
        excerpt: previewExcerpt.textContent,
        image: resizedImageData,
      };

      const current = JSON.parse(localStorage.getItem('posts') || '[]');
      localStorage.setItem('posts', JSON.stringify([newPost, ...current]));

      alert('投稿を保存しました。トップページで確認できます。');
      form.reset();
      resizedImageData = '';
      dateEl.value = today;
      updatePreview();
    });
  </script>
</body>
</html>
