<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>EMPEROR.NEWS | AI COVE-kun</title>
  <link rel="stylesheet" href="../assets/styles.css" />
</head>
<body class="home-page">
  <header class="site-header">
    <div class="inner">
      <div class="brand">
        <div class="brand-mark" aria-hidden="true"></div>
        <div>
          <p class="brand-kicker">BLOG</p>
          <p class="brand-title" data-site-title>EMPEROR.NEWS</p>
        </div>
      </div>
      <nav class="nav-links" aria-label="メインナビゲーション">
        <a href="../index.html" class="nav-link">トップ</a>
        <a href="../admin/index.html" class="nav-link">管理ページ</a>
        <a href="index.html" class="nav-link active">AI COVE-kun</a>
      </nav>
    </div>
  </header>

  <main>
    <section class="section">
      <div class="inner">
        <p class="kicker">AI COVE-kun</p>
        <h1>多言語デコード・アシスタント</h1>
        <p class="lead">原文と学習ルールを入力すると、指定フォーマットでデコード結果を整形して表示します。</p>
        <div class="info-grid" style="align-items: stretch;">
          <form class="info-card" id="decode-form">
            <div class="field">
              <label for="original-input">ORIGINAL_INPUT</label>
              <textarea id="original-input" rows="7" placeholder="[ORIGINAL_INPUT]\nここに原文を入力"></textarea>
            </div>
            <div class="field">
              <label for="learning-items">LEARNING_ITEMS</label>
              <textarea id="learning-items" rows="6" placeholder="- language: ja\n  source: 読\n  target: よみ\n  note: 例"></textarea>
            </div>
            <div class="field">
              <label for="user-correction">USER_CORRECTION (任意)</label>
              <textarea id="user-correction" rows="4" placeholder="ユーザー補正があれば入力"></textarea>
            </div>
            <p class="decode-status" id="decode-status" role="status" aria-live="polite"></p>
            <div class="form-actions">
              <button class="btn primary" type="submit">Decode</button>
              <button class="btn ghost" type="button" id="clear-button">Clear</button>
            </div>
          </form>

          <div class="info-card">
            <div class="section-header">
              <div>
                <p class="kicker">Decoded</p>
                <h2>出力プレビュー</h2>
              </div>
            </div>
            <pre class="output-panel" id="decoded-output">[DECODED_OUTPUT]
（ここに結果が表示されます）</pre>
          </div>
        </div>
      </div>
    </section>

    <section class="section muted">
      <div class="inner">
        <div class="section-header">
          <div>
            <p class="kicker">Guideline</p>
            <h2>運用ルールの要点</h2>
          </div>
        </div>
        <div class="info-grid">
          <div class="info-card">
            <h3>優先順位</h3>
            <ul>
              <li>確定済みの学習ルールを最優先で適用。</li>
              <li>競合があれば文脈に合うものを選択。</li>
              <li>確信が低い場合は原文を保持。</li>
            </ul>
          </div>
          <div class="info-card">
            <h3>出力ルール</h3>
            <ul>
              <li>返答は <strong>[DECODED_OUTPUT]</strong> のみ。</li>
              <li>説明や補足は出力に含めない。</li>
              <li>多言語の混在を維持。</li>
            </ul>
          </div>
          <div class="info-card">
            <h3>学習抽出</h3>
            <ul>
              <li>USER_CORRECTION が確定した場合のみ抽出。</li>
              <li>再利用できる最小単位のルールを追加。</li>
              <li>言語タグは ISO/BCP-47 を使用。</li>
            </ul>
          </div>
        </div>
      </div>
    </section>
  </main>

  <footer class="site-footer">
    <div class="inner footer-grid">
      <div>
        <p class="brand-title" data-site-title>EMPEROR.NEWS</p>
        <p class="muted-text" data-footer-description>シンプルで統一感のあるブログ体験を届けます。</p>
      </div>
      <div id="site-theme-picker" class="footer-theme-picker" aria-label="表示テーマ選択"></div>
    </div>
  </footer>

  <script>
    const form = document.getElementById('decode-form');
    const originalInput = document.getElementById('original-input');
    const learningItems = document.getElementById('learning-items');
    const userCorrection = document.getElementById('user-correction');
    const output = document.getElementById('decoded-output');
    const status = document.getElementById('decode-status');
    const clearButton = document.getElementById('clear-button');

    const extractBlock = (label, text) => {
      const pattern = new RegExp(`\\[${label}\\]([\\s\\S]*?)(?=\\n\\[[A-Z_]+\\]|$)`, 'i');
      const match = text.match(pattern);
      return match ? match[1].trim() : '';
    };

    const parseLearningItems = (block) => {
      if (!block) {
        return [];
      }
      return block
        .split(/\n(?=-\s*language:)/)
        .map((chunk) => {
          const sourceMatch = chunk.match(/source:\s*(.+)/);
          const targetMatch = chunk.match(/target:\s*(.+)/);
          if (!sourceMatch || !targetMatch) {
            return null;
          }
          return {
            source: sourceMatch[1].trim(),
            target: targetMatch[1].trim(),
          };
        })
        .filter(Boolean);
    };

    const applyReplacements = (text, items) => {
      return items.reduce((result, item) => {
        if (!item.source) {
          return result;
        }
        return result.split(item.source).join(item.target);
      }, text);
    };

    form.addEventListener('submit', (event) => {
      event.preventDefault();
      const rawText = originalInput.value.trim();
      const blockInput = extractBlock('ORIGINAL_INPUT', rawText) || rawText;
      let learningBlock = learningItems.value.trim();
      if (!learningBlock && rawText.includes('[LEARNING_ITEMS]')) {
        learningBlock = extractBlock('LEARNING_ITEMS', rawText);
      }

      const decoded = applyReplacements(blockInput, parseLearningItems(learningBlock));
      const correction = userCorrection.value.trim();
      const resultText = decoded || '（入力がありません）';

      output.textContent = `[DECODED_OUTPUT]\n${resultText}`;
      if (correction) {
        status.textContent = '補正入力を検出しました。デコード結果を更新しました。';
      } else {
        status.textContent = 'デコードが完了しました。';
      }
    });

    clearButton.addEventListener('click', () => {
      originalInput.value = '';
      learningItems.value = '';
      userCorrection.value = '';
      output.textContent = '[DECODED_OUTPUT]\n（ここに結果が表示されます）';
      status.textContent = '';
    });
  </script>
</body>
</html>
